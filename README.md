
[English](#event-raw-format-conversion-code) | [中文](#event-raw-格式转换代码)

# Event RAW Format Conversion Code

## Q&A

1. What is this code for?

	It is used to read [RAW format](https://docs.prophesee.ai/stable/data/file_formats/raw.html) events generated by Prophesee cameras and convert them to more convenient formats (such as csv, npz, h5).

	**Update**: Now it also supports reading [AEDAT3.1 format](https://docs.inivation.com/software/software-advanced-usage/file-formats/aedat-3.1.html) .aedat files. This is an older AEDAT format produced by devices like DVS128, which cannot be read by the dv-processing library.

2. Why not use the official Metavision library?

	Because I don't want to set up the environment.

3. Why not use the official OpenEB library?

	Because I don't want to compile it myself.

4. Pure Python is too slow.

	Yes, it's slow.

5. Why not optimize it?

	Because I'm lazy. Also, format conversion only needs to be run once, so it's good enough for now.

## Environment Setup

It should work with a relatively new version of Python. I use Python 3.12, but haven't tested others.

You need to install numpy to run the decoder.

To save to csv or h5 format, you need to additionally install csv or h5py. If you don't want to install them, you can comment out the corresponding code.

The built-in video visualization currently uses the ffmpeg-python library (note: use `pip install ffmpeg-python`, not `pip install ffmpeg`). This library will look for the ffmpeg executable in your system PATH, so you need to install ffmpeg first. If you don't want to bother with ffmpeg, you can modify the code to use another library or simply comment out this feature.

## Usage

Basic usage:
```bash
python event_reader.py input_file.raw
python event_reader.py input_file.aedat
```

Full command line options:
```bash
python event_reader.py input_file.raw [options]
```

**Available options:**
- `--max-events NUM` : Limit the maximum number of events to read
- `--output-csv FILE` : Output event data to a CSV file
- `--output-trigger-csv FILE` : Output trigger event data to a CSV file  
- `--output-npz FILE` : Output data to an NPZ file (NumPy compressed format)
- `--output-h5 FILE` : Output data to an H5 file (HDF5 format)
- `--output-video FILE` : Output event visualization video (MP4 format)
- `--stats-only` : Only show statistics, do not save any data files

**Examples:**

```bash
# Only view statistics, do not save files.
python event_reader.py recording.raw --stats-only

# Output to CSV format. EXT_TRIGGER events are usually used for time synchronization, H5 and NPZ formats will save event and trigger events together, but CSV format needs to save them in two separate files.
python event_reader.py recording.raw --output-csv events.csv --output-trigger-csv triggers.csv

# Only read the first 1,000,000 events, output to multiple formats and save visualization video.
python event_reader.py recording.raw --max-events 1000000 --output-h5 events.h5 --output-npz events.npz --output-video events.mp4
```

If your program crashes during reading, it's most likely because there is too much data and you ran out of memory. You can try reducing `--max-events`. (You may ask: I still want to read the entire RAW file, what should I do? — You can use a computer with more memory, or ask an AI to optimize this code for you.)

---

# Event RAW 格式转换代码

## Q&A

1. 这些代码是用来干什么的？

	用来读取Prophesee相机产生的 [RAW格式](https://docs.prophesee.ai/stable/data/file_formats/raw.html) event，并转为更方便的其他格式（如csv、npz、h5）。

	**更新**：现在也支持读取 [AEDAT3.1格式](https://docs.inivation.com/software/software-advanced-usage/file-formats/aedat-3.1.html) 的.aedat文件了。这是一种比较老的aedat格式，由DVS128等型号产出，目前用dv-processing库无法读取。

2. 为什么不用官方的Metavision库？

	因为我不想配环境。

3. 为什么不用官方的OpenEB库？

	因为我不想自己编译。

4. 纯Python跑得太慢了。

	是的，很慢。

5. 为什么不优化优化？
	
	因为我懒。而且格式转换只需要跑一遍，凑合着用用得了。

## 环境配置

用比较新的Python版本应该就能跑，我用的是Python 3.12，别的没有试过。

运行解码需要安装numpy。

保存到csv格式或h5格式需要额外安装csv或h5py，如果不想安装可以注释掉对应代码。

目前内置的视频可视化用的是ffmpeg-python这个库（注意，是`pip install ffmpeg-python`，不是`pip install ffmpeg`），这个库会根据你电脑上的PATH寻找可执行的ffmpeg文件，所以你需要先安装一个ffmpeg。如果你不想折腾ffmpeg，可以自己修改代码用别的库，或者直接注释掉这个功能。

## 使用方法

基本使用方法：
```bash
python event_reader.py input_file.raw
python event_reader.py input_file.aedat
```

完整的命令行参数说明：
```bash
python event_reader.py input_file.raw [选项]
```

**可用选项：**
- `--max-events NUM` : 限制最大读取事件数量
- `--output-csv FILE` : 输出事件数据到CSV文件
- `--output-trigger-csv FILE` : 输出触发事件数据到CSV文件  
- `--output-npz FILE` : 输出数据到NPZ文件（NumPy压缩格式）
- `--output-h5 FILE` : 输出数据到H5文件（HDF5格式）
- `--output-video FILE` : 输出事件可视化视频（MP4格式）
- `--stats-only` : 只显示统计信息，不保存任何数据文件

**使用示例：**

```bash
# 只查看统计信息，不保存文件。
python event_reader.py recording.raw --stats-only

# 输出到CSV格式。EXT_TRIGGER事件通常被用于时间同步等，H5格式和NPZ格式都会把event和trigger事件一起保存，但CSV格式需要把它们分成两个文件分别保存。
python event_reader.py recording.raw --output-csv events.csv --output-trigger-csv triggers.csv

# 只读取前1000000个事件，输出到多种格式并保存可视化视频。
python event_reader.py recording.raw --max-events 1000000 --output-h5 events.h5 --output-npz events.npz --output-video events.mp4
```

如果你的程序读着读着闪退了，这大概率是数据太多爆内存了。你可以减小`--max-event`试试。（这时你可能想问，我还是想读取整个RAW文件，怎么办？——你可以换一台内存更大的电脑。或者自己找个AI再优化一下这个代码。）